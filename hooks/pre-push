#!/usr/bin/env bash
# Pre-push: lint + typecheck + unit tests + Playwright suite (all parallel).
set -euo pipefail

# shellcheck source=shared.sh
source "$(dirname "$0")/shared.sh"

echo "üîç Pre-push checks..."

# ‚îÄ‚îÄ Rebase check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Fetch remote silently and abort early if local branch is behind.
BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE=$(git config "branch.${BRANCH}.remote" 2>/dev/null || echo "origin")
REMOTE_BRANCH="${REMOTE}/${BRANCH}"

git fetch "$REMOTE" "$BRANCH" --quiet 2>/dev/null || true

if git rev-parse --verify "$REMOTE_BRANCH" >/dev/null 2>&1; then
  BEHIND=$(git rev-list --count "HEAD..${REMOTE_BRANCH}")
  if [ "$BEHIND" -gt 0 ]; then
    echo "‚ùå Push blocked: your branch is $BEHIND commit(s) behind ${REMOTE_BRANCH}."
    echo "   Run: git pull --rebase"
    exit 1
  fi
fi

_be_lint()  { cd "$ROOT/backend";  uv run ruff check .; }
_be_mypy()  { cd "$ROOT/backend";  uv run mypy src; }
_be_tests() { cd "$ROOT/backend";  uv run pytest -q --tb=short --cov --cov-report=term-missing; }
_fe_types() { cd "$ROOT/frontend"; npm run typecheck --silent; }
_fe_unit()  { cd "$ROOT/frontend"; npm run test:coverage --silent; }
_fe_e2e()   {
  cd "$ROOT/frontend"
  npm run test:ct --silent
  npx nyc report --reporter=text --check-coverage --temp-dir=.nyc_output
}

run_parallel "Push blocked" \
  "backend:lint"    _be_lint  \
  "backend:mypy"    _be_mypy  \
  "backend:tests"   _be_tests \
  "frontend:types"  _fe_types \
  "frontend:unit"   _fe_unit  \
  "frontend:e2e"    _fe_e2e

echo "‚úÖ All checks passed ‚Äî pushing."
